<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TRPG BGM from Youtube</title>
    <style>
        :root { --primary: #bb86fc; --bg: #121212; --card: #1e1e1e; --text: #e0e0e0; --accent: #03dac6; }
        body { font-family: 'Pretendard', sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 20px; display: flex; justify-content: center; }
        .container { width: 100%; max-width: 600px; display: none; }
        
        /* ì…ì¥ ë° ì ê¸ˆ í™”ë©´ */
        #login-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg); z-index: 20000; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .login-card { background: var(--card); padding: 30px; border-radius: 15px; border: 1px solid #333; text-align: center; width: 320px; }
        #audio-unlock { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 10000; display: none; flex-direction: column; justify-content: center; align-items: center; cursor: pointer; }
        
        #players-container { width: 1px; height: 1px; overflow: hidden; position: absolute; opacity: 0; }
        .card { background: var(--card); border-radius: 12px; padding: 20px; margin-bottom: 15px; border: 1px solid #333; }
        input, button { background: #2c2c2c; color: #fff; border: 1px solid #444; padding: 12px; border-radius: 6px; margin: 5px 0; width: 100%; box-sizing: border-box; }
        button { cursor: pointer; background: #3700b3; border: none; font-weight: bold; }
        button:hover { background: #6200ee; }
        
        /* ë‹¤ì¤‘ ì¬ìƒ ì»¨íŠ¸ë¡¤ UI */
        .active-track-item { background: #252525; padding: 15px; border-radius: 10px; margin-top: 10px; border-left: 4px solid var(--accent); }
        .active-title { font-weight: bold; color: var(--accent); display: flex; justify-content: space-between; margin-bottom: 10px; }
        .active-controls { display: flex; gap: 5px; }
        .active-controls button { padding: 6px; font-size: 0.75rem; margin: 0; }
        .progress-bar { width: 100%; cursor: pointer; height: 6px; accent-color: var(--primary); margin-top: 10px; }
        .time-info { font-size: 0.7rem; color: #888; display: flex; justify-content: space-between; }

        /* í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ */
        .playlist-item { background: #252525; padding: 12px; border-radius: 8px; margin-bottom: 8px; border: 1px solid #333; cursor: grab; }
        .playlist-item.dragging { opacity: 0.5; border: 2px dashed var(--primary); }
        .item-main { display: flex; justify-content: space-between; align-items: center; }
        .item-meta { font-size: 0.7rem; color: #666; margin-top: 5px; line-height: 1.4; }
        .btn-group { display: flex; gap: 4px; }
        .small-btn { padding: 4px 8px; font-size: 0.7rem; width: auto; margin: 0; }
        
        #log-area { font-size: 0.7rem; color: #888; background: #000; padding: 10px; border-radius: 5px; height: 100px; overflow-y: auto; margin-top: 10px; border: 1px solid #333; }
        .host-only { display: none; }
    </style>
</head>
<body>

    <div id="login-screen">
        <div class="login-card">
            <h1 style="color:var(--primary); font-size: 1.1rem; margin-bottom: 20px;">TRPG BGM from Youtube</h1>
            <input type="text" id="input-room-name" placeholder="ë°© ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”">
            <button onclick="enterRoom('host')">í˜¸ìŠ¤íŠ¸(GM) ì…ì¥</button>
            <button onclick="enterRoom('guest')" style="background:#444">ê²ŒìŠ¤íŠ¸ ì…ì¥</button>
        </div>
    </div>

    <div id="audio-unlock" onclick="unlockAudio()">
        <div style="font-size: 60px;">ğŸ§</div>
        <b>í´ë¦­í•˜ì—¬ ì‚¬ìš´ë“œ í™œì„±í™”</b>
    </div>

    <div class="container" id="main-container">
        <div class="card">
            <h2 style="color: var(--primary); margin: 0 0 10px 0; font-size: 1rem;">ROOM: <span id="room-display"></span></h2>
            <div id="players-container"></div>
            
            <p style="margin: 20px 0 5px 0; font-size: 0.85rem; color: #888; font-weight: bold;">í˜„ì¬ ì¬ìƒ ì¤‘ì¸ BGM</p>
            <div id="active-tracks-ui">
                <p id="no-bgm-msg" style="font-size: 0.85rem; color: #555;">ì¬ìƒ ì¤‘ì¸ ê³¡ì´ ì—†ìŠµë‹ˆë‹¤.</p>
            </div>
        </div>

        <div id="host-panel" class="host-only card">
            <h3 style="margin-top:0; font-size: 0.9rem;">ê³¡ ì¶”ê°€</h3>
            <input type="text" id="yt-url" placeholder="ìœ íŠœë¸Œ URL">
            <input type="text" id="custom-title" placeholder="í‘œì‹œ ì œëª©">
            <div style="display:flex; align-items:center; gap:10px; font-size:0.8rem; margin:5px 0;">
                <span>í•œê³¡ ë°˜ë³µ</span><input type="checkbox" id="is-loop" style="width:auto;">
            </div>
            <button onclick="addToPlaylist()" style="background:#444">ëª©ë¡ì— ì¶”ê°€</button>
            <div style="display: flex; gap: 5px;">
                <button onclick="savePlaylist()" style="flex:1; background:#333; font-size:0.7rem;">ğŸ’¾ ë¦¬ìŠ¤íŠ¸ ì €ì¥</button>
                <button onclick="document.getElementById('file-input').click()" style="flex:1; background:#333; font-size:0.7rem;">ğŸ“‚ ë¶ˆëŸ¬ì˜¤ê¸°</button>
                <button onclick="resetServerData()" style="flex:1; background:#b71c1c; font-size:0.7rem;">ğŸ§¹ ë°© ì´ˆê¸°í™”</button>
            </div>
            <input type="file" id="file-input" style="display:none" onchange="loadPlaylist(event)">
        </div>

        <div class="card">
            <h3 id="playlist-header" style="margin-top:0; font-size: 0.9rem;">í”Œë ˆì´ë¦¬ìŠ¤íŠ¸</h3>
            <div id="playlist-container"></div>
            <div id="log-area">ë¡œê·¸ ëŒ€ê¸° ì¤‘...</div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
    <script src="https://www.youtube.com/iframe_api"></script>

    <script>
        function log(msg) {
            const area = document.getElementById('log-area');
            area.innerHTML += `<div>> ${msg}</div>`;
            area.scrollTop = area.scrollHeight;
            console.log(msg);
        }

        const firebaseConfig = {
            apiKey: "AIzaSyCmuKgORZHasMoHTfldQdN8AEBYwR2uOQ0",
            authDomain: "trpg-bgm-from.firebaseapp.com",
            databaseURL: "https://trpg-bgm-from-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "trpg-bgm-from",
            storageBucket: "trpg-bgm-from.firebasestorage.app",
            messagingSenderId: "731757785916",
            appId: "1:731757785916:web:f02ee6e3d03f5e91856439"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let roomId = "";
        let isHost = false;
        let playlist = [];
        let players = {};

        function enterRoom(role) {
            const name = document.getElementById('input-room-name').value.trim();
            if (!name) return alert("ë°© ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.");
            
            roomId = name;
            isHost = (role === 'host');
            
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('audio-unlock').style.display = 'flex';
            document.getElementById('main-container').style.display = 'block';
            document.getElementById('room-display').innerText = roomId;
            
            if (isHost) {
                document.querySelectorAll('.host-only').forEach(el => el.style.display = 'block');
                document.getElementById('playlist-header').innerText = 'í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ (ë“œë˜ê·¸í•˜ì—¬ ìˆœì„œ ë³€ê²½)';
            }
            
            initSync();
            log(`${roomId} ë°©ì— ì…ì¥í–ˆìŠµë‹ˆë‹¤.`);
            setInterval(updateAllProgress, 1000); // íƒ€ì„ ë°” ì—…ë°ì´íŠ¸ ì‹œì‘
        }

        function unlockAudio() {
            document.getElementById('audio-unlock').style.display = 'none';
            log("ì˜¤ë””ì˜¤ ì¥ì¹˜ê°€ í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤.");
        }

        function initSync() {
            db.ref(`rooms/${roomId}/active`).on('value', (snap) => {
                const activeData = snap.val() || {};
                const activeIds = Object.keys(activeData);
                
                // 1. UI ìƒì„± (ìš”êµ¬ì‚¬í•­ 1)
                const uiContainer = document.getElementById('active-tracks-ui');
                if (activeIds.length === 0) {
                    uiContainer.innerHTML = '<p id="no-bgm-msg" style="font-size: 0.85rem; color: #555;">ì¬ìƒ ì¤‘ì¸ ê³¡ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
                } else {
                    uiContainer.innerHTML = '';
                    activeIds.forEach(vid => {
                        const track = activeData[vid];
                        const div = document.createElement('div');
                        div.className = 'active-track-item';
                        div.innerHTML = `
                            <div class="active-title">
                                <span>${track.title}</span>
                                <span style="font-size:0.7rem; opacity:0.6;">${track.loop ? 'ğŸ”„ ë£¨í”„' : 'â¡ï¸ 1íšŒ'}</span>
                            </div>
                            <div class="active-controls" ${isHost ? '' : 'style="display:none;"'}>
                                <button onclick="sendControl('${vid}', 'playing')" style="background:#1b5e20">ì¬ìƒ</button>
                                <button onclick="sendControl('${vid}', 'paused')" style="background:#e65100">ì¼ì‹œì •ì§€</button>
                                <button onclick="sendControl('${vid}', 'stopped')" style="background:#b71c1c">ì •ì§€</button>
                            </div>
                            <div class="host-only" style="display:${isHost ? 'block' : 'none'};">
                                <input type="range" class="progress-bar" id="bar-${vid}" value="0" min="0" step="1" oninput="manualSeek('${vid}', this.value)">
                                <div class="time-info">
                                    <span id="cur-${vid}">0:00</span>
                                    <span id="tot-${vid}">0:00</span>
                                </div>
                            </div>
                        `;
                        uiContainer.appendChild(div);
                    });
                }

                // 2. í”Œë ˆì´ì–´ ê´€ë¦¬
                activeIds.forEach(vid => {
                    if (!players[vid]) {
                        createPlayer(vid, activeData[vid].loop, activeData[vid].title);
                    } else {
                        const p = players[vid];
                        if (p.getPlayerState) {
                            if (activeData[vid].status === 'playing') p.playVideo();
                            if (activeData[vid].status === 'paused') p.pauseVideo();
                            if (activeData[vid].status === 'stopped') { p.pauseVideo(); p.seekTo(0); }
                        }
                    }
                });

                // 3. ì •ì§€ëœ ê³¡ ì œê±°
                Object.keys(players).forEach(vid => {
                    if (!activeData[vid]) {
                        players[vid].stopVideo();
                        players[vid].destroy();
                        delete players[vid];
                    }
                });
                
                render();
            });
        }

        function createPlayer(vid, loop, title) {
            const div = document.createElement('div');
            div.id = `player-${vid}`;
            document.getElementById('players-container').appendChild(div);

            players[vid] = new YT.Player(`player-${vid}`, {
                height: '1', width: '1',
                videoId: vid,
                playerVars: { 'autoplay': 1, 'controls': 0, 'playsinline': 1 },
                events: {
                    'onReady': (e) => { e.target.playVideo(); log(`ì¬ìƒ ì‹œì‘: [${title}]`); },
                    'onStateChange': (e) => {
                        if (e.data === YT.PlayerState.ENDED && loop) e.target.playVideo();
                    }
                }
            });
        }

        function updateAllProgress() {
            if (!isHost) return;
            Object.keys(players).forEach(vid => {
                const p = players[vid];
                if (p.getPlayerState && p.getPlayerState() === YT.PlayerState.PLAYING) {
                    const cur = p.getCurrentTime();
                    const tot = p.getDuration();
                    const bar = document.getElementById(`bar-${vid}`);
                    if (bar) {
                        bar.max = tot;
                        bar.value = cur;
                        document.getElementById(`cur-${vid}`).innerText = formatTime(cur);
                        document.getElementById(`tot-${vid}`).innerText = formatTime(tot);
                    }
                }
            });
        }

        function formatTime(s) {
            const m = Math.floor(s / 60);
            const sec = Math.floor(s % 60);
            return `${m}:${sec < 10 ? '0' : ''}${sec}`;
        }

        function manualSeek(vid, val) {
            if (players[vid]) players[vid].seekTo(val);
        }

        async function addToPlaylist() {
            const url = document.getElementById('yt-url').value;
            const vid = url.match(/(?:v=|\/)([0-9A-Za-z_-]{11})/)?.[1];
            if (!vid) return alert("URLì„ í™•ì¸í•˜ì„¸ìš”.");

            let title = document.getElementById('custom-title').value;
            let originalTitle = "ì •ë³´ ì—†ìŒ";
            try {
                const res = await fetch(`https://noembed.com/embed?url=${url}`);
                const data = await res.json();
                originalTitle = data.title || "BGM";
                if (!title) title = originalTitle;
            } catch (e) { title = title || "BGM"; }

            playlist.push({ id: vid, title: title, originalTitle: originalTitle, url: url, loop: document.getElementById('is-loop').checked });
            render();
            document.getElementById('yt-url').value = "";
            document.getElementById('custom-title').value = "";
        }

        function render() {
            const container = document.getElementById('playlist-container');
            container.innerHTML = '';

            playlist.forEach((item, i) => {
                const isActive = !!players[item.id];
                const div = document.createElement('div');
                div.className = 'playlist-item';
                div.draggable = isHost;
                div.innerHTML = `
                    <div class="item-main">
                        <span style="font-weight:bold;">${item.title} ${isActive ? '<span style="color:var(--accent); font-size:0.7rem;">[ON]</span>' : ''}</span>
                        <div class="btn-group">
                            ${isHost ? `
                                <button class="small-btn" onclick="toggleLoop(${i})">${item.loop ? 'ğŸ”„' : 'â¡ï¸'}</button>
                                <button class="small-btn" onclick="togglePlay('${item.id}', '${item.title}', ${item.loop})">${isActive ? 'STOP' : 'PLAY'}</button>
                                <button class="small-btn" onclick="editTrack(${i})" style="background:#555">ìˆ˜ì •</button>
                                <button class="small-btn" onclick="removeTrack(${i})" style="background:#b71c1c">X</button>
                            ` : ''}
                        </div>
                    </div>
                    ${isHost ? `<div class="item-meta">ğŸ”— ${item.url}<br>ğŸ“„ ì›ì œ: ${item.originalTitle}</div>` : ''}
                `;

                if (isHost) {
                    div.addEventListener('dragstart', () => div.classList.add('dragging'));
                    div.addEventListener('dragend', () => { div.classList.remove('dragging'); saveOrder(); });
                }
                container.appendChild(div);
            });

            if (isHost) {
                container.addEventListener('dragover', e => {
                    e.preventDefault();
                    const dragging = document.querySelector('.dragging');
                    const siblings = [...container.querySelectorAll('.playlist-item:not(.dragging)')];
                    const next = siblings.find(s => e.clientY <= s.offsetTop + s.offsetHeight / 2);
                    container.insertBefore(dragging, next);
                });
            }
        }

        function saveOrder() {
            const titles = [...document.querySelectorAll('.playlist-item span:first-child')].map(el => el.innerText.split(' [ON]')[0].trim());
            playlist = titles.map(t => playlist.find(p => p.title === t)).filter(p => p);
            log("ìˆœì„œê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.");
        }

        function togglePlay(vid, title, loop) {
            const ref = db.ref(`rooms/${roomId}/active/${vid}`);
            if (players[vid]) {
                ref.remove();
                log(`ì •ì§€: [${title}]`);
            } else {
                ref.set({ title: title, status: 'playing', loop: loop });
            }
        }

        function editTrack(i) {
            const newTitle = prompt("ìˆ˜ì •í•  ê³¡ ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”:", playlist[i].title);
            const newUrl = prompt("ìˆ˜ì •í•  ìœ íŠœë¸Œ URLì„ ì…ë ¥í•˜ì„¸ìš”:", playlist[i].url);
            if (newTitle) playlist[i].title = newTitle;
            if (newUrl) {
                const vid = newUrl.match(/(?:v=|\/)([0-9A-Za-z_-]{11})/)?.[1];
                if (vid) { playlist[i].url = newUrl; playlist[i].id = vid; }
            }
            render();
        }

        function toggleLoop(i) { playlist[i].loop = !playlist[i].loop; render(); }
        function removeTrack(i) { if(confirm("ì‚­ì œ?")) { playlist.splice(i, 1); render(); } }
        function resetServerData() { if(confirm("ì´ˆê¸°í™”?")) { db.ref(`rooms/${roomId}`).remove(); location.reload(); } }
        function savePlaylist() {
            const blob = new Blob([JSON.stringify(playlist)], {type: "application/json"});
            const a = document.createElement("a"); a.href = URL.createObjectURL(blob); a.download = `playlist.json`; a.click();
        }
        function loadPlaylist(e) {
            const reader = new FileReader();
            reader.onload = (ev) => { playlist = JSON.parse(ev.target.result); render(); };
            reader.readAsText(e.target.files[0]);
        }
        function onYouTubeIframeAPIReady() { console.log("Youtube API Ready."); }
    </script>
</body>
</html>