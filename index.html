<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MATIDA BGM SYNC - Pro</title>
    <style>
        :root { --primary: #bb86fc; --bg: #121212; --card: #1e1e1e; --text: #e0e0e0; --accent: #03dac6; }
        body { font-family: sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 20px; display: flex; justify-content: center; }
        .container { width: 100%; max-width: 600px; }
        #audio-unlock { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.98); z-index: 10000; display: flex; flex-direction: column; justify-content: center; align-items: center; cursor: pointer; text-align: center; }
        #player-wrapper { width: 1px; height: 1px; overflow: hidden; opacity: 0; position: absolute; }
        .card { background: var(--card); border-radius: 12px; padding: 20px; margin-bottom: 15px; border: 1px solid #333; }
        input, button { background: #2c2c2c; color: #fff; border: 1px solid #444; padding: 10px; border-radius: 6px; margin: 5px 0; box-sizing: border-box; }
        button { cursor: pointer; background: #3700b3; border: none; font-weight: bold; }
        button:hover { background: #6200ee; }
        .host-only { display: none; }
        #current-title { color: var(--accent); font-weight: bold; font-size: 1.1rem; }
        
        /* íƒ€ì„ ë°” ìŠ¤íƒ€ì¼ */
        #progress-container { margin-top: 10px; display: none; }
        #progress-bar { width: 100%; cursor: pointer; height: 8px; accent-color: var(--primary); }
        #time-info { font-size: 0.75rem; color: #888; display: flex; justify-content: space-between; margin-top: 2px; }

        /* í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ ì•„ì´í…œ ìŠ¤íƒ€ì¼ */
        .playlist-item { padding: 12px; border-bottom: 1px solid #333; display: flex; flex-direction: column; gap: 5px; }
        .item-main { display: flex; justify-content: space-between; align-items: center; }
        .item-meta { font-size: 0.7rem; color: #666; line-height: 1.4; }
        .btn-group { display: flex; gap: 4px; }
        .small-btn { padding: 4px 8px; font-size: 0.7rem; background: #444; }
        
        #log-area { font-size: 0.7rem; color: #888; background: #000; padding: 10px; border-radius: 5px; height: 80px; overflow-y: auto; margin-top: 10px; border: 1px solid #333; }
        .checkbox-group { display: flex; align-items: center; gap: 8px; font-size: 0.85rem; margin: 10px 0; }
    </style>
</head>
<body>

    <div id="audio-unlock" onclick="startSession()">
        <div style="font-size: 60px; margin-bottom: 20px;">ğŸ§</div>
        <b>í´ë¦­í•˜ì—¬ BGM ì„¸ì…˜ ì‹œì‘</b>
    </div>

    <div class="container">
        <div class="card">
            <h2 style="color: var(--primary); margin: 0 0 15px 0; font-size: 1.1rem;">MATIDA SYNC <span id="room-id" style="font-size: 0.7rem; color: #666;"></span></h2>
            <div id="player-wrapper"><div id="player"></div></div>
            
            <div style="margin-bottom: 10px;">
                <p style="font-size: 0.8rem; color: #888; margin: 0;">í˜„ì¬ ì¬ìƒ ê³¡</p>
                <div id="current-title">ëŒ€ê¸° ì¤‘...</div>
                
                <div id="progress-container" class="host-only">
                    <input type="range" id="progress-bar" value="0" min="0" step="1" oninput="manualSeek(this.value)">
                    <div id="time-info">
                        <span id="time-current">0:00</span>
                        <span id="time-total">0:00</span>
                    </div>
                </div>
            </div>

            <div id="host-controls" class="host-only" style="display: flex; gap: 5px;">
                <button onclick="sendControl('playing')" style="flex:1; background:#1b5e20">ì¬ìƒ</button>
                <button onclick="sendControl('paused')" style="flex:1; background:#e65100">ì¼ì‹œì •ì§€</button>
                <button onclick="sendControl('stopped')" style="flex:1; background:#b71c1c">ì •ì§€</button>
            </div>
        </div>

        <div id="host-panel" class="host-only card">
            <h3 style="margin: 0 0 10px 0; font-size: 1rem;">GM ê´€ë¦¬</h3>
            <input type="text" id="yt-url" style="width:100%" placeholder="ìœ íŠœë¸Œ ì£¼ì†Œ ë³µì‚¬">
            <input type="text" id="custom-title" style="width:100%" placeholder="ê³¡ ì œëª©">
            
            <div class="checkbox-group">
                <span>í•œê³¡ ë°˜ë³µ</span>
                <input type="checkbox" id="is-loop" style="width:auto; margin:0;">
            </div>

            <button onclick="addToPlaylist()" style="width:100%; background: #444;">í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ ì¶”ê°€</button>
            
            <div style="display: flex; gap: 5px; margin-top:5px;">
                <button onclick="savePlaylist()" style="flex:1; background:#333; font-size: 0.7rem;">ğŸ’¾ ì €ì¥</button>
                <button onclick="document.getElementById('file-input').click()" style="flex:1; background:#333; font-size: 0.7rem;">ğŸ“‚ ë¶ˆëŸ¬ì˜¤ê¸°</button>
                <button onclick="resetData()" style="flex:1; background:#b71c1c; font-size: 0.7rem;">ğŸ§¹ ì´ˆê¸°í™”</button>
            </div>
            <input type="file" id="file-input" style="display:none" onchange="loadPlaylist(event)">
        </div>

        <div class="card">
            <h3 style="margin-top:0; font-size: 0.9rem;">í”Œë ˆì´ë¦¬ìŠ¤íŠ¸</h3>
            <div id="playlist-container"></div>
            <div id="log-area">ì‹œìŠ¤í…œ ì´ˆê¸°í™” ì¤‘...</div>
            <button onclick="enableHostMode()" style="background:transparent; color:#444; font-size:0.6rem; border:none; margin-top:10px;">GM ê¶Œí•œ ê°•ì œ í™œì„±í™”</button>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
    <script src="https://www.youtube.com/iframe_api"></script>

    <script>
        function log(msg) {
            const area = document.getElementById('log-area');
            area.innerHTML += `<div>> ${msg}</div>`;
            area.scrollTop = area.scrollHeight;
        }

        const firebaseConfig = {
            apiKey: "AIzaSyCmuKgORZHasMoHTfldQdN8AEBYwR2uOQ0",
            authDomain: "trpg-bgm-from.firebaseapp.com",
            databaseURL: "https://trpg-bgm-from-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "trpg-bgm-from",
            storageBucket: "trpg-bgm-from.firebasestorage.app",
            messagingSenderId: "731757785916",
            appId: "1:731757785916:web:f02ee6e3d03f5e91856439"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        const urlParams = new URLSearchParams(window.location.search);
        let roomId = urlParams.get('room');
        let isHost = urlParams.get('host') === 'true' || !roomId;

        if (!roomId) {
            roomId = Math.random().toString(36).substring(2, 8);
            window.history.replaceState({}, '', `?room=${roomId}&host=true`);
            isHost = true;
        }
        document.getElementById('room-id').innerText = `ROOM: ${roomId}`;

        function applyHostUI() {
            if (isHost) {
                document.querySelectorAll('.host-only').forEach(el => el.style.display = 'block');
                log("GM ê¶Œí•œ í™œì„±í™”ë¨.");
            }
        }
        function enableHostMode() { isHost = true; applyHostUI(); render(); }
        applyHostUI();

        function resetData() {
            if(confirm("ì¬ìƒ ìƒíƒœë¥¼ ì´ˆê¸°í™”í• ê¹Œìš”?")) {
                db.ref(`rooms/${roomId}/state`).remove();
                log("ğŸ§¹ ì„œë²„ ë°ì´í„° ì´ˆê¸°í™” ì™„ë£Œ.");
                setTimeout(() => location.reload(), 500);
            }
        }

        let player;
        let isPlayerReady = false;
        let lastId = "";
        let lastStatus = "";

        function onYouTubeIframeAPIReady() {
            player = new YT.Player('player', {
                height: '10', width: '10',
                playerVars: { 'autoplay': 0, 'controls': 0, 'playsinline': 1 },
                events: {
                    'onReady': () => { 
                        isPlayerReady = true; 
                        log("âœ… í”Œë ˆì´ì–´ ì¤€ë¹„ ì™„ë£Œ!"); 
                        setInterval(updateProgress, 1000); // 1ì´ˆë§ˆë‹¤ íƒ€ì„ ë°” ì—…ë°ì´íŠ¸
                    },
                    'onError': (e) => log(`âŒ ìœ íŠœë¸Œ ì—ëŸ¬: ${e.data}`)
                }
            });
        }

        function startSession() {
            document.getElementById('audio-unlock').style.display = 'none';
            log("ğŸš€ ì˜¤ë””ì˜¤ í™œì„±í™”");
            if (isPlayerReady && lastId) player.playVideo();
        }

        // íƒ€ì„ ë°” ì—…ë°ì´íŠ¸ í•¨ìˆ˜ (í˜¸ìŠ¤íŠ¸ ì „ìš©)
        function updateProgress() {
            if (isPlayerReady && isHost && player.getPlayerState() === YT.PlayerState.PLAYING) {
                const current = player.getCurrentTime();
                const total = player.getDuration();
                const bar = document.getElementById('progress-bar');
                
                bar.max = total;
                bar.value = current;
                
                document.getElementById('time-current').innerText = formatTime(current);
                document.getElementById('time-total').innerText = formatTime(total);
                document.getElementById('progress-container').style.display = 'block';
            }
        }

        function formatTime(seconds) {
            const min = Math.floor(seconds / 60);
            const sec = Math.floor(seconds % 60);
            return `${min}:${sec < 10 ? '0' : ''}${sec}`;
        }

        function manualSeek(val) {
            if (isHost && isPlayerReady) player.seekTo(val);
        }

        // Firebase ë™ê¸°í™”
        db.ref(`rooms/${roomId}/state`).on('value', (snap) => {
            const data = snap.val();
            if (!data) {
                document.getElementById('current-title').innerText = "ëŒ€ê¸° ì¤‘...";
                document.getElementById('progress-container').style.display = 'none';
                return;
            }

            const vid = data.videoId ? data.videoId.toString().trim() : "";
            if (vid.length !== 11) return;

            document.getElementById('current-title').innerText = data.customTitle;

            if (isPlayerReady) {
                if (lastId !== vid) {
                    player.loadVideoById(vid);
                    lastId = vid;
                    lastStatus = "playing";
                }
                if (lastStatus !== data.status) {
                    if (data.status === 'playing') player.playVideo();
                    else if (data.status === 'paused') player.pauseVideo();
                    else if (data.status === 'stopped') { player.pauseVideo(); player.seekTo(0); }
                    lastStatus = data.status;
                }
            }
        });

        // í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ ê´€ë¦¬
        let playlist = [];
        
        async function addToPlaylist() {
            const url = document.getElementById('yt-url').value;
            const regExp = /^.*((youtu.be\/)|(v\/)|(\/u\/\w\/)|(embed\/)|(watch\?))\??v?=?([^#&?]*).*/;
            const match = url.match(regExp);
            const vid = (match && match[7].length == 11) ? match[7] : false;

            if (!vid) return alert("ìœ íŠœë¸Œ ì£¼ì†Œë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.");

            log("ê³¡ ì •ë³´ ê°€ì ¸ì˜¤ëŠ” ì¤‘...");
            // oEmbedë¥¼ ì´ìš©í•´ ì‹¤ì œ ì œëª© ê°€ì ¸ì˜¤ê¸°
            let originalTitle = "ì •ë³´ ì—†ìŒ";
            try {
                const response = await fetch(`https://noembed.com/embed?url=${url}`);
                const data = await response.json();
                originalTitle = data.title || "ì œëª©ì„ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŒ";
            } catch (e) { console.log("ì œëª© ë¡œë“œ ì‹¤íŒ¨"); }

            playlist.push({
                videoId: vid,
                customTitle: document.getElementById('custom-title').value || originalTitle,
                originalTitle: originalTitle,
                videoUrl: url,
                isLoop: document.getElementById('is-loop').checked
            });
            render();
            document.getElementById('yt-url').value = "";
            document.getElementById('custom-title').value = "";
        }

        function render() {
            const container = document.getElementById('playlist-container');
            container.innerHTML = playlist.map((item, i) => `
                <div class="playlist-item">
                    <div class="item-main">
                        <span style="font-weight:bold;">${item.customTitle} ${item.isLoop ? 'ğŸ”„' : ''}</span>
                        <div class="btn-group">
                            ${isHost ? `
                                <button class="small-btn" onclick="moveTrack(${i}, -1)">â–²</button>
                                <button class="small-btn" onclick="moveTrack(${i}, 1)">â–¼</button>
                                <button class="small-btn" onclick="editTrack(${i})" style="background:#555">ìˆ˜ì •</button>
                                <button class="small-btn" onclick="playTrack(${i})" style="background:var(--accent); color:#000">ì¬ìƒ</button>
                                <button class="small-btn" onclick="removeTrack(${i})" style="background:#b71c1c">X</button>
                            ` : ''}
                        </div>
                    </div>
                    ${isHost ? `
                        <div class="item-meta">
                            ğŸ“„ ì›ì œ: ${item.originalTitle}<br>
                            ğŸ”— <a href="${item.videoUrl}" target="_blank" style="color:#888;">${item.videoUrl}</a>
                        </div>
                    ` : ''}
                </div>
            `).join('');
        }

        function moveTrack(index, direction) {
            const newIndex = index + direction;
            if (newIndex < 0 || newIndex >= playlist.length) return;
            const temp = playlist[index];
            playlist[index] = playlist[newIndex];
            playlist[newIndex] = temp;
            render();
        }

        function editTrack(index) {
            const newTitle = prompt("ìˆ˜ì •í•  ê³¡ ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”:", playlist[index].customTitle);
            if (newTitle) {
                playlist[index].customTitle = newTitle;
                render();
            }
        }

        function removeTrack(index) {
            if(confirm("ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                playlist.splice(index, 1);
                render();
            }
        }

        function playTrack(i) {
            db.ref(`rooms/${roomId}/state`).set({ ...playlist[i], status: 'playing', ts: Date.now() });
        }

        function sendControl(s) {
            db.ref(`rooms/${roomId}/state/status`).set(s);
        }

        function savePlaylist() {
            const blob = new Blob([JSON.stringify(playlist)], {type: "application/json"});
            const a = document.createElement("a");
            a.href = URL.createObjectURL(blob); a.download = `matida_bgm.json`; a.click();
        }

        function loadPlaylist(e) {
            const reader = new FileReader();
            reader.onload = (ev) => { playlist = JSON.parse(ev.target.result); render(); };
            reader.readAsText(e.target.files[0]);
        }
    </script>
</body>
</html>